## unity冷启动简介

从点击游戏到Unity的闪屏出现这段时间通常定义为冷启动的时间。相比于Android或者iOS原生App，Unity3D引擎开发的游戏在冷启动时间上确实比较长。

而IL2CPP相比于Mono确实能够加快冷启动时间，这是可以预期的。因为在Mono编译的情况下，每个 .cs 文件都是一个 TextAsset 文件，而所有的 .cs 文件都需要在冷启动时候全部加载到内存中，这些碎片化的文件加载操作都会占用冷启动时间。关于冷启动需要加载哪些文件的分析，可以参考Unity3D游戏在启动时都默认加载哪些资源。而IL2CPP会把所有的C#代码编译成C 代码，然后再进行编译、链接等操作，这样就减少了C#、DLL所带来的开销。

在项目中我们应该怎样加快游戏的冷启动速度呢？经过调研，我总结出以下几个优化的要点：

- 1.项目中添加一个Loading场景，这个场景会是游戏启动的第一个场景。

- 2.在Loading场景中尽量少的依赖，尽量少的纹理依赖、AssetBundle依赖、代码依赖，总之，这个Loading场景一定要尽量少的依赖，这个场景一定要尽量简单，这样才能保证尽快的加载速度。

- 3.在游戏中尽量少的使用Resources方式管理资源，Resources目录下面的所有资源会在ResourceManager中记录下来，而ResourceManager就是一个文件，通常是一个YAML格式的文本文件。而这个文件是会在冷启动时加载的。所以Resources目录下面的有越多的资源，那么这个ResourceManager就会越大，加载时间也会越长。

- 4.使用Resources方式管理资源还有一个坏处，就是所有的资源都是统一管理的，这样的资源的管理粒度没办法控制。建议使用AssetBundle的方式管理，这样可以使用多个AssetBundle来管理资源。把在Loading场景中需要的最小资源集放在一个AssetBundle中，这样在冷启动时启动Loading场景时，只需要加载一个AssetBundle即可。选择合适的粒度管理AssetBundle，可以在合适的时候加载某一个AssetBundle，不使用时就可以卸载某一个AssetBundle。

- 5.在Loading场景中，添加一个进度条，然后 同步加载 进入主场景所需要的AssetBundle，这样用户就不会感到等待时间太烦躁了。**同步加载要比异步加载时间更短。**

- 6.纹理资源在游戏中一般是最大的资源，选择合适的压缩格式进行压缩，既可以减少内存占用，又能够加快资源的加载速度。压缩格式的选择要从显示效果和压缩率上进行权衡。一般在Android上使用ETC格式，在iOS上使用PVRTC格式，在某些情况下，可能还可以考虑使用Alpha通道分离技术进行压缩处理。

- 7.代码文件可以编译成 .dll 文件， 减少大量TextAsset文件导致的碎片化加载时间。

- 8.强烈建议使用IL2CPP后端，如果使用IL2CPP，则可以忽略第7条。
- 9.清理插件中不需要的资源
- 10.查看Always Include中没有shader变体，有的话用[ShaderVariantCollection](https://docs.unity3d.com/ScriptReference/ShaderVariantCollection.html)等方案替代。
- 11.注意设置Web请求的超时时长。我们在游戏启动的时候做了一些hook的事情，会有Web请求，后来我们遇到一个情况是在很多机器上会黑屏等待30s甚至60s这样的时长，后来发现是因为这个Web请求没有设置超时时间，于是使用了机器默认的超时时间，在不同设备上不同，比如红米2A上会有接近1分钟的超时限制。这个很坑，只是因为那个非必须的Web服务没有正确开启，导致排查了很长时间。

Native层增加界面，减少黑屏等待，提升玩家体验。这个并不能真正解决问题，只是一种缓解手段，等到优化做到位了，其实也就不需要了。

