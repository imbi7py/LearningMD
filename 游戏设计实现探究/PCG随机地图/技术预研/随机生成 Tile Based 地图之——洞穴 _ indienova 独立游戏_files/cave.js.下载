var matrix=[],points=[],w=240,h=280,sw=280,sh=310,boxSize=8,smallBoxSize=4,svg=[],counter=[],counterMax=[5,7,7,7],ids=["normalAlgorithm","advancedAlgorithm"],Tile={FLOOR:0,WALL:1};
jQuery(document).ready(function(){for(var c=d3.scale.linear().domain([0,30]).range([0,240]),c=d3.svg.axis().scale(c).orient("top").ticks(5),b=d3.scale.linear().domain([0,35]).range([0,280]),b=d3.svg.axis().scale(b).orient("left").ticks(7),a=0;3>a;a++){initData(a);2==a&&(sh=160);svg[a]=d3.select("#svg-"+a).append("svg").attr({width:sw,height:sh});if(2>a)svg[a].selectAll("rect").data(points[a]).enter().append("rect").attr("width",boxSize).attr("height",boxSize).attr("x",function(a){return 30+a.col*
boxSize}).attr("y",function(a){return 20+a.row*boxSize}).attr("fill",function(a){return 1==a.value?"#666666":"#eeffff"}),svg[a].append("g").attr("class","axis").attr("transform","translate(30, 20)").call(c),svg[a].append("g").attr("class","axis").attr("transform","translate(30, 20)").call(b);else for(var d=[20,10+sw/2],e=a;e<=a+1;e++)svg[a].append("g").attr("id",ids[e-2]).selectAll("rect").data(points[a]).enter().append("rect").attr("width",smallBoxSize).attr("height",smallBoxSize).attr("x",function(a){return d[e-
2]+a.col*smallBoxSize}).attr("y",function(a){return 20+a.row*smallBoxSize}).attr("fill",function(a){return 1==a.value?"#666666":"#eeffff"});counter[a]=0}jQuery(".b-next").on("click",function(){var a=parseInt(jQuery(this).data("board"));0==a&&checkWallsA(a);1==a&&checkWallsB(a);2==a&&(checkWallsA(a),checkWallsB(a+1));reDraw(a);counter[a]++;counter[a]==counterMax[a]&&jQuery(this).prop("disabled",!0)});jQuery(".b-reset").on("click",function(){var a=jQuery(this).data("board");initData(a);reDraw(a);counter[a]=
0;jQuery(this).next().prop("disabled",!1)})});
function initData(c){var b;b=0==c?.55:.6;points[c]=[];matrix[c]=[];for(var a=0;a<h/boxSize;a++){matrix[c][a]=[];for(var d=0;d<w/boxSize;d++)matrix[c][a][d]=0==a||0==d||a==h/boxSize-1||d==w/boxSize-1?Tile.WALL:Math.random()>b?Tile.WALL:Tile.FLOOR,points[c].push({row:a,col:d,value:matrix[c][a][d]})}if(2==c)for(points[c+1]=[],matrix[c+1]=[],b=0;b<h/boxSize;b++)for(matrix[c+1][b]=[],a=0;a<w/boxSize;a++)matrix[c+1][b][a]=matrix[c][b][a],points[c+1].push({row:b,col:a,value:matrix[c][b][a]})}
function reDraw(c){points[c]=[];2==c&&(points[c+1]=[]);console.log("reDraw board:",c);for(var b=0;b<h/boxSize;b++)for(var a=0;a<w/boxSize;a++)points[c].push({row:b,col:a,value:matrix[c][b][a]}),2==c&&points[c+1].push({row:b,col:a,value:matrix[c+1][b][a]});switch(c){case 0:case 1:svg[c].selectAll("rect").data(points[c]).transition().duration(500).ease("linear").each("start",function(a){if(0!=counter[c]){var b=d3.select(this).attr("fill");("#666666"==b&&a.value==Tile.FLOOR||"#eeffff"==b&&a.value==Tile.WALL)&&
d3.select(this).attr("fill","orange")}else d3.select(this).attr("fill","orange")}).attr("fill",function(a){return a.value==Tile.WALL?"#666666":"#eeffff"});break;case 2:for(b=0;b<ids.length;b++)svg[c].select("#"+ids[b]).selectAll("rect").data(points[c+b]).transition().duration(500).ease("linear").each("start",function(a){if(0!=counter[c]){var b=d3.select(this).attr("fill");("#666666"==b&&a.value==Tile.FLOOR||"#eeffff"==b&&a.value==Tile.WALL)&&d3.select(this).attr("fill","orange")}else d3.select(this).attr("fill",
"orange")}).attr("fill",function(a){return a.value==Tile.WALL?"#666666":"#eeffff"})}}
function checkWallsA(c){var b,a,d=[];for(b=0;b<h/boxSize;b++)for(d[b]=[],a=0;a<w/boxSize;a++)d[b][a]=matrix[c][b][a];for(a=0;a<h/boxSize;a++)for(var e=0;e<w/boxSize;e++){b=0;for(var f=a-1;f<=a+1;f++)for(var g=e-1;g<=e+1;g++)if(f!=a||g!=e)0>f||0>g||f==h/boxSize||g==w/boxSize?b++:matrix[c][f][g]==Tile.WALL&&b++;d[a][e]=matrix[c][a][e]==Tile.WALL?4<=b?Tile.WALL:Tile.FLOOR:5<=b?Tile.WALL:Tile.FLOOR}for(b=0;b<h/boxSize;b++)for(a=0;a<w/boxSize;a++)matrix[c][b][a]=d[b][a]}
function checkWallsB(c){var b,a,d,e,f,g,l,m,k=[];for(a=0;a<h/boxSize;a++)for(k[a]=[],b=0;b<w/boxSize;b++)k[a][b]=matrix[c][a][b];4>counter[c]?(l=5,m=2):(l=5,m=0);for(a=1;a<h/boxSize-1;a++)for(b=1;b<w/boxSize-1;b++){g=f=0;for(d=-1;1>=d;d++)for(e=-1;1>=e;e++)matrix[c][a+d][b+e]!=Tile.FLOOR&&f++;for(d=a-2;d<=a+2;d++)for(e=b-2;e<=b+2;e++)if(2!=Math.abs(d-a)||2!=Math.abs(e-b))0>d||0>e||d>=h/boxSize||e>=w/boxSize||matrix[c][d][e]!=Tile.FLOOR&&g++;k[a][b]=f>=l||g<=m?Tile.WALL:Tile.FLOOR}for(a=0;a<h/boxSize;a++)for(b=
0;b<w/boxSize;b++)matrix[c][a][b]=k[a][b]};