<!DOCTYPE html>
<!-- saved from url=(0052)https://gameinstitute.qq.com/community/detail/107937 -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="csrf-token" content="U5FzYadXPITwl4RDWayFniJeXYurHTh8MgCjWdm2">
            <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
                <title>四叉树优化碰撞检测-腾讯游戏学院</title>
                <meta name="keywords" content="四叉树优化碰撞检测">
                <meta name="description" content="四叉树优化碰撞检测">
        <link href="https://gameinstitute.qq.com/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link rel="stylesheet" href="./四叉树优化碰撞检测-腾讯游戏学院_files/global.css">
        <link rel="stylesheet" href="./四叉树优化碰撞检测-腾讯游戏学院_files/editor.b57141.css">
    <link rel="stylesheet" href="./四叉树优化碰撞检测-腾讯游戏学院_files/detail.css">
    <link rel="canonical" href="http://gameinstitute.qq.com/community/detail/107937">
    <script src="./四叉树优化碰撞检测-腾讯游戏学院_files/stats.js.下载" name="MTAH5" sid="500607596" cid="500607598"></script><script src="./四叉树优化碰撞检测-腾讯游戏学院_files/aq_common.js.下载"></script>
</head>
<body>
    <div id="_app">
        <header class="m-header">
    <div class="header-wrap">
        <a class="header-logo" href="https://gameinstitute.qq.com/">
            <img width="281" height="42" src="./四叉树优化碰撞检测-腾讯游戏学院_files/logo-white.png" alt="腾讯游戏学院，成就游戏梦想">
        </a>
        <nav class="header-nav">
            <ul class="navbar">
                <li class="navbar-item ">
                    <h3 class="navbar-title">
                        <a class="link" href="https://gameinstitute.qq.com/">首页<sub class="lang-en">HOME</sub></a>
                    </h3>
                </li>
                <li class="navbar-item expand ">
                    <h3 class="navbar-title">
                        <a class="link" href="https://gameinstitute.qq.com/college/lecture">高校教育<sub class="lang-en">UNIVERSITY</sub></a>
                    </h3>
                    <div class="navbar-menu">
                        <ul class="menu-list">
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/college/lecture">高校讲堂</a></li>
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/college/competition">赛事活动</a></li>
                        </ul>
                    </div>
                </li>
                <li class="navbar-item expand  cur ">
                    <h3 class="navbar-title">
                        <a class="link" href="https://gameinstitute.qq.com/tgdc/2018">行业共建<sub class="lang-en">INDUSTRY</sub></a>
                    </h3>
                    <div class="navbar-menu">
                        <ul class="menu-list">
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/tgdc/2018">TGDC</a></li>
                            <li class="menu-item"><a class="link" href="https://gwb.tencent.com/cn" target="_blank">GWB</a></li>
                            <li class="menu-item  cur "><a class="link" href="https://gameinstitute.qq.com/community">开发者社区</a></li>
                        </ul>
                    </div>
                </li>
                <li class="navbar-item expand ">
                    <h3 class="navbar-title">
                        <a class="link" href="https://gameinstitute.qq.com/course">精品课程<sub class="lang-en">OPEN&nbsp;COURSES</sub></a>
                    </h3>
                    <div class="navbar-menu">
                        <ul class="menu-list">
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/course">基础课程</a></li>
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/course/high">进阶课程</a></li>
                        </ul>
                    </div>
                </li>
                <li class="navbar-item expand ">
                    <h3 class="navbar-title">
                        <a class="link" href="https://gameinstitute.qq.com/talk">热门专栏<sub class="lang-en">FEATURES</sub></a>
                    </h3>
                    <div class="navbar-menu">
                        <ul class="menu-list">
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/talk">论道</a></li>
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/article">真经阁</a></li>
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/tech-ebook">技术手册</a></li>
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/gamepie">游戏派</a></li>
                        </ul>
                    </div>
                </li>
                <li class="navbar-item expand ">
                    <h3 class="navbar-title">
                        <a class="link" href="https://gameinstitute.qq.com/beginner">关于学院<sub class="lang-en">ABOUT&nbsp;US</sub></a>
                    </h3>
                    <div class="navbar-menu">
                        <ul class="menu-list">
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/beginner">培养体系</a></li>
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/minigame">MiniGame展示</a></li>
                            <li class="menu-item "><a class="link" href="https://gameinstitute.qq.com/aboutus">关于我们</a></li>
                        </ul>
                    </div>
                </li>
            </ul>
        </nav>
        <div class="header-tools">
            <div class="search">
                <div class="search-enter">
                    <i class="g-vector-search"></i>
                </div>
                <div class="search-area">
                    <div class="search-area__wrap">
                        <div class="hot">
                            <a class="hot-pic" href="https://gameinstitute.qq.com/course/detail/10032" target="_blank">
                                <img width="230" height="127" src="./四叉树优化碰撞检测-腾讯游戏学院_files/1520218960104336.jpg" alt="《天涯明月刀》研运历程分享">
                                <span class="gico-play-1"></span>
                            </a>
                            <p class="hot-title">《天涯明月刀》研运历程分享</p>
                            <div class="hot-info">
                                <span class="style">
                                    <a class="style-1" href="https://gameinstitute.qq.com/search/course?keywords=%E5%88%B6%E4%BD%9C%E4%BA%BA" target="_blank">制作人</a>
                                    <span class="split">|</span>
                                    <a class="style-2" href="https://gameinstitute.qq.com/search/course?keywords=%E9%A1%B9%E7%9B%AE%E5%88%86%E4%BA%AB" target="_blank">项目分享</a>
                                </span>
                                <span class="view">2.5W人看过</span>
                            </div>
                        </div>
                        <div class="search-area__inner">
                            <div class="search-bar">
                                <form action="https://gameinstitute.qq.com/search/course" method="get" target="_blank">
                                    <input class="search-key" name="keywords" type="text" placeholder="输入关键词...">
                                    <button class="search-btn" type="submit">搜索</button>
                                </form>
                            </div>
                            <div class="keys">
                                <a class="key-label" href="https://gameinstitute.qq.com/search/course?keywords=TGDC" target="_blank">TGDC</a>
                                <a class="key-label" href="https://gameinstitute.qq.com/search/course?keywords=%E7%AD%96%E5%88%92" target="_blank">策划</a>
                                <a class="key-label" href="https://gameinstitute.qq.com/search/course?keywords=%E7%BE%8E%E6%9C%AF" target="_blank">美术</a>
                                <a class="key-label" href="https://gameinstitute.qq.com/search/course?keywords=%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank">服务器</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="login">
                                    <div class="login-before" v-show="!IS_LOGIN">你好，请<a class="link" href="javascript:;" @click="login()">[登录]</a></div>
                    <div class="login-after" v-show="IS_LOGIN" v-cloak="">
                        <a class="username" target="_blank" href="https://gameinstitute.qq.com/user">
                            <img class="headpic" width="40" height="40" :src="USER_INFO.avatar" alt="">
                        </a>
                        <a class="link" href="https://gameinstitute.qq.com/community/detail/107937#" @click="logOut">[注销]</a>
                    </div>
                            </div>
        </div>
    </div>
</header>
            <div class="m-container p-detail">
        <div class="main">
            <div class="m-breadcrumb cy-breadcrumb">
                <a class="breadcrumb-item" href="https://gameinstitute.qq.com/community">开发者社区</a>
                <span class="breadcrumb-spilt">&gt;</span>
                <span class="breadcrumb-item">程序</span>
            </div>
            <article class="detail-wrap">
                <h1 class="detail-title">四叉树优化碰撞检测</h1>
                                <div class="detail-data">
                    <div class="data-time">发表于<span class="time">2016-07-06</span></div>
                    <div class="m-toolbar data-toolbar">
                        <div class="toolbar-main">
                            <like type="small" :like_count.sync="like_count" :liked.sync="liked" :id="107937"></like>
                            <a class="toolbar-item" type="button" href="https://gameinstitute.qq.com/community/detail/107937#commit">
                                <i class="toolbar-ico g-vector-commit"></i>
                                <span class="toolbar-txt">评论<em class="num">0</em></span>
                            </a>
                            <share class-name="toolbar-share" url="https://gameinstitute.qq.com/community/detail/107937" desc="　　游戏中碰撞检测分为两个阶段：broad phase 和 narrow phase。接下来要介绍的就是broad phase。在broad phase这个阶段，我们的主要任务是将屏幕上的物体进行筛选，筛选出最可能发生碰撞的物体集合。 　　试想想，屏幕上有N个物体，如果我们对每两个物体都进行碰撞检测，那时间复杂度就有N^2。但实际上，在游戏画面中，并不是每两个物体都需要进行碰撞检测，比如一个在屏幕右上方的物体和一个在屏幕左上方的物体之间明显是不会发生碰撞的，所以我们不需要对这两个物体进行碰撞检测。那么，现在" title="四叉树优化碰撞检测" qrcode="https://gameinstitute.qq.com/community/detail/107937"></share>
                            <span class="toolbar-item view"><span class="toolbar-txt"><em class="num">886</em>浏览</span></span>
                        </div>
                    </div>
                </div>
                                                <div class="detail-qqgroup">
                    <p class="text">想免费获取内部独家PPT资料库？观看行业大牛直播？点击加入腾讯游戏学院游戏程序行业精英群</p>
                    <a class="group-num" target="_blank" href="https://shang.qq.com/wpa/qunwpa?idkey=3fcf6147441efc8b343eb7447e6a996eabb6a33093306529c4d1e9d2ab75423d">
                        <i class="g-vector-qqgroup"></i>711501594
                    </a>
                </div>
                                <section class="art-wrap">
                    <div class="art-cnt tigskin ck-content" v-pre="">
                        <div><span style="font-family:微软雅黑;font-size:medium;">　　游戏中碰撞检测分为两个阶段：broad phase 和 narrow phase。接下来要介绍的就是broad phase。在broad phase这个阶段，我们的主要任务是将屏幕上的物体进行筛选，筛选出最可能发生碰撞的物体集合。</span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　试想想，屏幕上有N个物体，如果我们对每两个物体都进行碰撞检测，那时间复杂度就有N^2。但实际上，在游戏画面中，并不是每两个物体都需要进行碰撞检测，比如一个在屏幕右上方的物体和一个在屏幕左上方的物体之间明显是不会发生碰撞的，所以我们不需要对这两个物体进行碰撞检测。那么，现在我们就需要一个这样的算法去将屏幕上可能和不可能发生碰撞的物体区分开来。</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><b>一、四叉树原理</b></span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　正如其名，四叉树就是每个父节点都具有四个子节点的树状数据结构。由于要区分屏幕上的物体，我们要将屏幕划分为四个区域，所以四叉树的四个节点正合适表示这四个区域。</span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　屏幕上四个区域分别为：左上区域 + 右上区域 + 右下区域 + 左下区域，方便起见，我们分别命名为：象限1、象限2、象限3、象限4：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div style="text-align: center;"><img src="./四叉树优化碰撞检测-腾讯游戏学院_files/php1Z8Lfv.1467816065.jpg"></div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　我们将完全处于某一个象限的物体存储在该象限对应的子节点下，当然，也存在跨越多个象限的物体，我们将它们存在父节点中：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div style="text-align: center;"><img src="./四叉树优化碰撞检测-腾讯游戏学院_files/phpXzgDiO.1467816073.jpg"></div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　如果某个象限内的物体的数量过多，它会同样会分裂成四个子象限，以此类推：</span> </div><div style="text-align: center;"><img src="./四叉树优化碰撞检测-腾讯游戏学院_files/phpXWP5jL.1467816080.jpg"></div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><b>二、实现四叉树</b></span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　我们先定义四叉树的结构：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><div><div id="highlighter_678003" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript comments">/* </code> </div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">四叉树节点包含：</code> </div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- objects: 用于存储物体对象</code> </div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- nodes: 存储四个子节点</code> </div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- level: 该节点的深度，根节点的默认深度为0</code> </div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- bounds: 该节点对应的象限在屏幕上的范围，bounds是一个矩形</code> </div><div class="line number7 index6 alt2"><code class="jscript comments">*/</code> </div><div class="line number8 index7 alt1"><code class="jscript keyword">var</code> <code class="jscript plain">QuadTree = </code><code class="jscript keyword">function</code> <code class="jscript plain">QuadTree(bounds, level) {</code> </div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.objects = [];</code> </div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes = [];</code> </div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.level = </code><code class="jscript keyword">typeof</code> <code class="jscript plain">level === </code><code class="jscript string">'undefined'</code> <code class="jscript plain">? 0 : level;</code> </div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.bounds = bounds;</code> </div><div class="line number13 index12 alt2"><code class="jscript plain">}</code> </div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="jscript comments">/*</code> </div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">常量：</code> </div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- MAX_OBJECTS: 每个节点（象限）所能包含物体的最大数量</code> </div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- MAX_LEVELS: 四叉树的最大深度</code> </div><div class="line number19 index18 alt2"><code class="jscript comments">*/</code> </div><div class="line number20 index19 alt1"><code class="jscript plain">QuadTree.prototype.MAX_OBJECTS = 10;</code> </div><div class="line number21 index20 alt2"><code class="jscript plain">QuadTree.prototype.MAX_LEVELS = 5;</code> </div><div class="line number22 index21 alt1"><code class="jscript plain">接下来，我们需要判断屏幕上的物体属于哪个象限：</code> </div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="jscript comments">/* </code> </div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">获取物体对应的象限序号，以屏幕中心为界限，切割屏幕:</code> </div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- 右上：象限一</code> </div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- 左上：象限二</code> </div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- 左下：象限三</code> </div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">- 右下：象限四</code> </div><div class="line number30 index29 alt1"><code class="jscript comments">*/</code> </div><div class="line number31 index30 alt2"><code class="jscript plain">QuadTree.prototype.getIndex = </code><code class="jscript keyword">function</code><code class="jscript plain">(rect) {</code> </div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">bounds = </code><code class="jscript keyword">this</code><code class="jscript plain">.bounds,</code> </div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">onTop = rect.y + rect.height &lt;=&nbsp; bounds.centroid.y,</code> </div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">onBottom = rect.y &gt;= bounds.centroid.y,</code> </div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">onLeft = rect.x + rect.w &lt;= bounds.centroid.x,</code> </div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">onRight = rect.x &gt;= bounds.centroid.x;</code> </div><div class="line number37 index36 alt2">&nbsp;</div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(onTop) {</code> </div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(onRight) {</code> </div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">0;</code> </div><div class="line number41 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">} </code><code class="jscript keyword">else</code> <code class="jscript keyword">if</code> <code class="jscript plain">(onLeft) {</code> </div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">1;</code> </div><div class="line number43 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">} </code><code class="jscript keyword">else</code> <code class="jscript keyword">if</code> <code class="jscript plain">(onBottom) {</code> </div><div class="line number45 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(onLeft) {</code> </div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">2;</code> </div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">} </code><code class="jscript keyword">else</code> <code class="jscript keyword">if</code> <code class="jscript plain">(onRight) {</code> </div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">3;</code> </div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number50 index49 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number51 index50 alt2">&nbsp;</div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 如果物体跨越多个象限，则放回-1</code> </div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">-1;</code> </div><div class="line number54 index53 alt1"><code class="jscript plain">};</code> </div></div></td></tr></tbody></table></div></div><br></div><div><span style="font-family:微软雅黑;font-size:medium;">　　我们知道，如果某一个象限（节点）内存储的物体数量超过了MAX_OBJECTS最大数量，则需要对这个节点进行划分，所以我们同样需要一个划分函数，它的工作就是将一个象限看作一个屏幕，将其划分为四个子象限：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><div><div id="highlighter_803934" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript comments">// 划分</code> </div><div class="line number2 index1 alt1"><code class="jscript plain">QuadTree.prototype.split = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code> </div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">level = </code><code class="jscript keyword">this</code><code class="jscript plain">.level,</code> </div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">bounds = </code><code class="jscript keyword">this</code><code class="jscript plain">.bounds,</code> </div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">x = bounds.x,</code> </div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">y = bounds.y,</code> </div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">sWidth = bounds.width / 2,</code> </div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">sHeight = bounds.height / 2;</code> </div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes.push(</code> </div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">new</code> <code class="jscript plain">QuadTree(</code><code class="jscript keyword">new</code> <code class="jscript plain">Rect(bounds.centroid.x, y, sWidth, sHeight), level + 1),</code> </div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">new</code> <code class="jscript plain">QuadTree(</code><code class="jscript keyword">new</code> <code class="jscript plain">Rect(x, y, sWidth, sHeight), level + 1),</code> </div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">new</code> <code class="jscript plain">QuadTree(</code><code class="jscript keyword">new</code> <code class="jscript plain">Rect(x, bounds.centroid.y, sWidth, sHeight), level + 1),</code> </div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">new</code> <code class="jscript plain">QuadTree(</code><code class="jscript keyword">new</code> <code class="jscript plain">Rect(bounds.centroid.x, bounds.centroid.y, sWidth, sHeight), level + 1)</code> </div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">);</code> </div><div class="line number16 index15 alt1"><code class="jscript plain">};</code> </div></div></td></tr></tbody></table></div></div><br></div><div><span style="font-family:微软雅黑;font-size:medium;">　　为了初始化四叉树，我们也需要实现四叉树的插入功能，用于将物体插入到四叉树中：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><div><div id="highlighter_652605" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript comments">/*</code> </div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">插入功能：</code> </div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">- 如果当前节点[ 存在 ]子节点，则检查物体到底属于哪个子节点，如果能匹配到子节点，则将该物体插入到该子节点中</code> </div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">- 如果当前节点[ 不存在 ]子节点，将该物体存储在当前节点。随后，检查当前节点的存储数量，如果超过了最大存储数量，则对当前节点进行划分，划分完成后，将当前节点存储的物体重新分配到四个子节点中。</code> </div><div class="line number5 index4 alt2"><code class="jscript comments">*/</code> </div><div class="line number6 index5 alt1"><code class="jscript plain">QuadTree.prototype.insert = </code><code class="jscript keyword">function</code><code class="jscript plain">(rect) {</code> </div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">objs = </code><code class="jscript keyword">this</code><code class="jscript plain">.objects,</code> </div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">i, index;</code> </div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 如果该节点下存在子节点</code> </div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes.length) {</code> </div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">index = </code><code class="jscript keyword">this</code><code class="jscript plain">.getIndex(rect);</code> </div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(index !== -1) {</code> </div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes[index].insert(rect);</code> </div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code><code class="jscript plain">;</code> </div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 否则存储在当前节点下</code> </div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">objs.push(rect);</code> </div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 如果当前节点存储的数量超过了MAX_OBJECTS</code> </div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(!</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes.length &amp;&amp;</code> </div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.objects.length &gt; </code><code class="jscript keyword">this</code><code class="jscript plain">.MAX_OBJECTS &amp;&amp;</code> </div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.level &lt; </code><code class="jscript keyword">this</code><code class="jscript plain">.MAX_LEVELS) {</code> </div><div class="line number26 index25 alt1">&nbsp;</div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.split();</code> </div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">for</code> <code class="jscript plain">(i = objs.length - 1; i &gt;= 0; i--) {</code> </div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">index = </code><code class="jscript keyword">this</code><code class="jscript plain">.getIndex(objs[i]);</code> </div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(index !== -1) {</code> </div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes[index].insert(objs.splice(i, 1)[0]);</code> </div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number36 index35 alt1"><code class="jscript plain">};</code> </div></div></td></tr></tbody></table></div></div><br></div><div><span style="font-family:微软雅黑;font-size:medium;"><b>三、筛选功能</b></span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　重头戏来啦！现在我们已经能够初始化一个四叉树了，接下来我们要解决——如何将可能发生碰撞的物体集合选取出来：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><div><div id="highlighter_355072" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript comments">/*</code> </div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">检索功能：</code> </div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">给出一个物体对象，该函数负责将该物体可能发生碰撞的所有物体选取出来。该函数先查找物体所属的象限，该象限下的物体都是有可能发生碰撞的，然后再递归地查找子象限...</code> </div><div class="line number4 index3 alt1"><code class="jscript comments">*/</code> </div><div class="line number5 index4 alt2"><code class="jscript plain">QuadTree.prototype.retrieve = </code><code class="jscript keyword">function</code><code class="jscript plain">(rect) {</code> </div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">result = [],</code> </div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">index;</code> </div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes.length) {</code> </div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">index = </code><code class="jscript keyword">this</code><code class="jscript plain">.getIndex(rect);</code> </div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(index !== -1) {</code> </div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">resutl = result.concat(</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes[index].retrieve(rect));</code> </div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">result = result.concat(</code><code class="jscript keyword">this</code><code class="jscript plain">.objects);</code> </div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">result;</code> </div><div class="line number19 index18 alt2"><code class="jscript plain">};</code> </div></div></td></tr></tbody></table></div></div><br></div><div><span style="font-family:微软雅黑;font-size:medium;">　　咋一看，这个函数貌似没什么问题，但是我们知道，并不是所有物体都恰好完全属于某一个象限的，比如有个物体跨越了象限一和象限二：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div style="text-align: center;"><img src="./四叉树优化碰撞检测-腾讯游戏学院_files/php8a4x3v.1467816179.jpg"></div><div style="text-align: center;"><br></div><div><span style="font-family:微软雅黑;font-size:medium;">　　一眼就能看出来，矩形6可能发生碰撞的物体集合包括：矩形1、矩形2和矩形5。而我们实现的retrive函数筛选出来的集合则是为空，显然是不正确的，我们需要改进这块代码。</span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　为了让跨越多个象限的物体也能递归地执行retrive函数，从而找到所有可能碰撞的物体集合，我们需要让这个物体同时属于这些象限。</span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　以矩形6为例，我们如何让矩形6同时属于象限二和象限三呢？我们的做法是：以象限的边界为切割线，将矩形6切割为两个子矩形。我们能够确定的是：这两个子矩形分别属于象限二和象限三，所以我们能用这两个子矩形递归的调用retrive函数，从而找到所有可能碰撞的物体集合。</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div style="text-align: center;"><img src="./四叉树优化碰撞检测-腾讯游戏学院_files/phpCaSFB3.1467816187.jpg"></div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　改进后的retrive函数：</span> </div><div><br></div><div><div><div id="highlighter_184866" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript comments">// 检索</code> </div><div class="line number2 index1 alt1"><code class="jscript plain">QuadTree.prototype.retrieve = </code><code class="jscript keyword">function</code><code class="jscript plain">(rect) {</code> </div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">result = [],</code> </div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">arr, i, index;</code> </div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes.length) {</code> </div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">index = </code><code class="jscript keyword">this</code><code class="jscript plain">.getIndex(rect);</code> </div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(index !== -1) {</code> </div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">resutl = result.concat(</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes[index].retrieve(rect));</code> </div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">} </code><code class="jscript keyword">else</code> <code class="jscript plain">{</code> </div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 切割矩形</code> </div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">arr = rect.carve(</code><code class="jscript keyword">this</code><code class="jscript plain">.bounds);</code> </div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">for</code> <code class="jscript plain">(i = arr.length - 1; i &gt;= 0; i--) {</code> </div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">index = </code><code class="jscript keyword">this</code><code class="jscript plain">.getIndex(arr[i]);</code> </div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">resutl = result.concat(</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes[index].retrieve(rect));</code> </div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">result = result.concat(</code><code class="jscript keyword">this</code><code class="jscript plain">.objects);</code> </div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">result;</code> </div><div class="line number26 index25 alt1"><code class="jscript plain">}</code> </div></div></td></tr></tbody></table></div></div><b><br></b> </div><div><span style="font-family:微软雅黑;font-size:medium;"><b>四、动态更新</b></span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　我们已经实现了四叉树全部的功能，先介绍一下四叉树的用法。</span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　首先创建一个四叉树：</span> </div><div><br></div><div><div><div id="highlighter_880264" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">tree = </code><code class="jscript keyword">new</code> <code class="jscript plain">Quadtree(</code><code class="jscript keyword">new</code> <code class="jscript plain">Rect(0, 0, 1000, 500));</code> </div></div></td></tr></tbody></table></div></div><br></div><div><span style="font-family:微软雅黑;font-size:medium;">　　接下来，我们需要初始化四叉树，我们将屏幕上的所有物体都插入到这个四叉树中：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><div><div id="highlighter_493592" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">rectsArr = [</code><code class="jscript comments">/* ... */</code><code class="jscript plain">];</code> </div><div class="line number2 index1 alt1"><code class="jscript plain">rectsArr.forEach(</code><code class="jscript keyword">function</code><code class="jscript plain">(rect) {</code> </div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">tree.insert(rect);</code> </div><div class="line number4 index3 alt1"><code class="jscript plain">});</code> </div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="jscript plain">　　一棵四叉树已经初始化完成，我们调用retrive找出每个物体对应的碰撞物体集合，并进行下一步的narrow phase部分的碰撞检测了：</code> </div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="jscript plain">rectsArr.forEach(</code><code class="jscript keyword">function</code><code class="jscript plain">(rect) {</code> </div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">result = tree.retrive(rect);</code> </div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">result.forEach(</code><code class="jscript keyword">function</code><code class="jscript plain">() {</code> </div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// norrow phase部分的碰撞检测...</code> </div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code> </div><div class="line number13 index12 alt2"><code class="jscript plain">})</code> </div></div></td></tr></tbody></table></div></div><br></div><div><span style="font-family:微软雅黑;font-size:medium;">　　我们现在知道四叉树的使用方法了，但同时我们也注意到一个问题：由于屏幕的物体是运行的，前一秒在象限一的物体可能下一秒就跑到象限二了，所以每一帧都需要重新初始化四叉树。这意味着，每16ms就要初始化一次四叉树，这个代价太大，太得不偿失了：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><div><div id="highlighter_996098" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">run = </code><code class="jscript keyword">function</code> <code class="jscript plain">run() {</code> </div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 重新向四叉树中插入所有物体，重新初始化四叉树</code> </div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// ...</code> </div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 筛选物体集合并进行碰撞检测</code> </div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// ...</code> </div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">requestAnimationFrame(run);</code> </div><div class="line number9 index8 alt2"><code class="jscript plain">};</code> </div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="jscript plain">requestAnimationFrame(run);</code> </div></div></td></tr></tbody></table></div></div><br></div><div><span style="font-family:微软雅黑;font-size:medium;">　　我们想想，是不是有这样做的必要？实际上，只是部分物体从一个象限跑到另一个象限，而其他物体都是保持在原先象限中，所以我们只需要重新插入这部分物体即可，从而避免了对所有物体进行插入操作。</span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　我们为四叉树增添这部分的功能，其名为动态更新：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><div><div id="highlighter_814899" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript comments">// 判断矩形是否在象限范围内</code> </div><div class="line number2 index1 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">isInner(rect, bounds) {</code> </div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">rect.x &gt;= bounds.x &amp;&amp;</code> </div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">rect.x + width &lt;= bounds.x + bounds.width &amp;&amp;</code> </div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">rect.y &gt;= bounds.y &amp;&amp;</code> </div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">rect.y + rect.height &lt;= bounds.y + bounds.height;</code> </div><div class="line number7 index6 alt2"><code class="jscript plain">}</code> </div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="jscript comments">/*</code> </div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">动态更新：</code> </div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">从根节点深入四叉树，检查四叉树各个节点存储的物体是否依旧属于该节点（象限）的范围之内，如果不属于，则重新插入该物体。</code> </div><div class="line number12 index11 alt1"><code class="jscript comments">*/</code> </div><div class="line number13 index12 alt2"><code class="jscript plain">QuadTree.prototype.refresh = </code><code class="jscript keyword">function</code><code class="jscript plain">(root) {</code> </div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">objs = </code><code class="jscript keyword">this</code><code class="jscript plain">.objects,</code> </div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">rect, index, i, len;</code> </div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">root = root || </code><code class="jscript keyword">this</code><code class="jscript plain">;</code> </div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">for</code> <code class="jscript plain">(i = objs.length - 1; i &gt;= 0; i--) {</code> </div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">rect = objs[i];</code> </div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">index = </code><code class="jscript keyword">this</code><code class="jscript plain">.getIndex(rect);</code> </div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 如果矩形不属于该象限，则将该矩形重新插入</code> </div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(!isInner(rect, </code><code class="jscript keyword">this</code><code class="jscript plain">.bounds)) {</code> </div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(</code><code class="jscript keyword">this</code> <code class="jscript plain">!== root) {</code> </div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">root.insert(objs.splice(i, 1)[0]);</code> </div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 如果矩形属于该象限 且 该象限具有子象限，则</code> </div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 将该矩形安插到子象限中</code> </div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">} </code><code class="jscript keyword">else</code> <code class="jscript keyword">if</code> <code class="jscript plain">(</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes.length) {</code> </div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes[index].insert(objs.splice(i, 1)[0]);</code> </div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 递归刷新子象限</code> </div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">for</code> <code class="jscript plain">(i = 0, len = </code><code class="jscript keyword">this</code><code class="jscript plain">.nodes.length; i &lt; len; i++) {</code> </div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.nodes[i].refresh(root);</code> </div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code> </div><div class="line number40 index39 alt1"><code class="jscript plain">};</code> </div></div></td></tr></tbody></table></div></div><br></div><div><span style="font-family:微软雅黑;font-size:medium;">　　现在有了动态更新功能，每一帧中只需要对该四叉树进行动态更新即可：</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><div><div id="highlighter_916907" class="syntaxhighlighter  jscript"><div class="toolbar"><a class="toolbar_item command_help help">?</a> </div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">run = </code><code class="jscript keyword">function</code> <code class="jscript plain">run() {</code> </div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 动态更新</code> </div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">tree.refresh();</code> </div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// 筛选物体集合并进行碰撞检测</code> </div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// ...</code> </div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">requestAnimationFrame(run);</code> </div><div class="line number9 index8 alt2"><code class="jscript plain">};</code> </div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="jscript plain">requestAnimationFrame(run);</code> </div></div></td></tr></tbody></table></div></div><br></div><div><span style="font-family:微软雅黑;font-size:medium;">　　以上。</span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><br></span> </div><div><span style="font-family:微软雅黑;font-size:medium;"><b>五、参考</b></span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　<a href="http://gamedevelopment.tutsplus.com/tutorials/quick-tip-use-quadtrees-to-detect-likely-collisions-in-2d-space--gamedev-374">Quick Tip: Use Quadtrees to Detect Likely Collisions in 2D Space</a></span> </div><div><span style="font-family:微软雅黑;font-size:medium;">　　<a href="http://bbs.9ria.com/thread-243675-1-1.html">四叉树碰撞优化版，速度飞一样</a></span> </div><b style="line-height: 1.5;"><span style="font-family: 微软雅黑, sans-serif; color: red; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial; --darkreader-inline-color:#ff3333; --darkreader-inline-bgimage: initial;" data-darkreader-inline-color="" data-darkreader-inline-bgimage="">　　</span><span style="color: red; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial; --darkreader-inline-color:#ff3333; --darkreader-inline-bgimage: initial;" data-darkreader-inline-color="" data-darkreader-inline-bgimage=""><span style="font-family:微软雅黑;font-size:medium;">腾讯</span></span></b><span style="font-family:微软雅黑;font-size:medium;"><b style="line-height: 1.5;"><span style="color: red; --darkreader-inline-color:#ff3333;" data-darkreader-inline-color="">GAD</span></b><b style="line-height: 1.5;"><span style="color: red; --darkreader-inline-color:#ff3333;" data-darkreader-inline-color="">游戏程序交流群：</span></b><span style="color: red; --darkreader-inline-color:#ff3333;" data-darkreader-inline-color="">484290331</span></span><a target="_blank" href="http://shang.qq.com/wpa/qunwpa?idkey=83b50c5b88402c9e5bb2d7b26e7aef01def43fc6c87dd476d13e90744900bcca"><img src="./四叉树优化碰撞检测-腾讯游戏学院_files/group.png" alt="Gad游戏开发核心用户群" title="Gad游戏开发核心用户群"></a>
                    </div>
                </section>
                <div class="art-foot">
                                        <div>
                        <p><a href="https://gameinstitute.qq.com/community/detail/107937" target="_blank">原文链接</a></p>
                        <p>著作权归作者所有，商业转载请联系作者获得授权，非商业转载请注明出处。</p>
                    </div>
                                                            <p class="report">如社区发表内容存在侵权行为，您可以<a class="link" href="https://gameinstitute.qq.com/about/complaint">点击这里</a>查看侵权投诉指引</p>
                    <div class="labels">
                        <p class="labels-tips">标签：</p>
                        <div class="labels-list"><a class="m-label cy-label" target="_blank" href="https://gameinstitute.qq.com/community/tag/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91">游戏开发</a><a class="m-label cy-label" target="_blank" href="https://gameinstitute.qq.com/community/tag/%E6%B8%B8%E6%88%8F%E8%A7%86%E8%A7%89">游戏视觉</a>                    </div>
                                            <like type="big" :like_count.sync="like_count" :liked.sync="liked" :id="107937"></like>
                                    </div>
            </div></article>
            <aside class=" detail-side ">
            <div class="row side-author">
            <div class="row-hd">
                <p class="author-tit">本文作者</p>
                <div class="author-info">
                    <a class="info-link" href="https://gameinstitute.qq.com/community/user/1177945">
                        <div class="info-img g-badge"><img class="headpic" src="./四叉树优化碰撞检测-腾讯游戏学院_files/phptbBCGq.1453634984.85x85.1453634993.jpg" width="50" height="50"></div>
                        <div class="info-txt">
                            <span class="name">彼岸无风</span>
                            <span class="intro">暂无简介</span>
                        </div>
                    </a>
                    <button class="m-btn secondary follow-btn" @click="followUser(1177945)" v-if="!itself &amp;&amp; !followed" type="button">关注</button>
                    <button v-cloak="" class="m-btn secondary follow-btn disabled" @mouseover="followText = &#39;取消关注&#39;" @mouseout="followText = &#39;已关注&#39;" @click="unfollowUser(1177945)" v-if="!itself &amp;&amp; followed" type="button">{{ followText }}</button>
                </div>
            </div>
            <div class="row-bd">
                <ul class="author-art">
                                        <li class="art-item"><a class="link" href="https://gameinstitute.qq.com/community/detail/113426">《人民的名义》之开发团队版，谁才是真正的主角？</a></li>
                                        <li class="art-item"><a class="link" href="https://gameinstitute.qq.com/community/detail/113243">关于颜色预乘（premultiply）</a></li>
                                        <li class="art-item"><a class="link" href="https://gameinstitute.qq.com/community/detail/113242">关于游戏开发中地图瓷砖贴图的过渡（tile）</a></li>
                                        <li class="art-item"><a class="link" href="https://gameinstitute.qq.com/community/detail/113241">网络游戏的移动同步（五）帧同步算法</a></li>
                                        <li class="art-item"><a class="link" href="https://gameinstitute.qq.com/community/detail/113240">Unity工作流分享一二</a></li>
                                    </ul>
            </div>
        </div>
                            <hot-tag></hot-tag>
                <div class="side-promotion">
            <a class="promotion-link" href="https://gameinstitute.qq.com/yxds-2019?ADTAG=community" target="_blank"><img src="./四叉树优化碰撞检测-腾讯游戏学院_files/ZgQyYnmlLZGBlJMjXToD.png" alt=""></a>
        </div>
        <div class="side-wechat">
        <div class="wechat-item">
            <span class="wechat-tit">GWB公众号</span>
            <span class="wechat-qrcode"><img class="qrcode" src="./四叉树优化碰撞检测-腾讯游戏学院_files/weixin_qrcode_gwb.png" width="138" height="138"></span>
        </div>
        <div class="wechat-item">
            <span class="wechat-tit">腾讯游戏学院公众号</span>
            <span class="wechat-qrcode"><img class="qrcode" src="./四叉树优化碰撞检测-腾讯游戏学院_files/weixin_qrcode.png" width="138" height="138"></span>
        </div>
    </div>
</aside>
            <div class="detail-commit" id="commit">
                                <comments :archive-id="107937"></comments>
                            </div>
        </div>
    </div>
        <footer class="m-footer">
    <div class="container">
        <div class="footer-main">
            <div class="friends">
                <h3>友情链接</h3>
                <div class="friends-link">
                    <a href="https://game.qq.com/" target="_blank" rel="nofollow">腾讯游戏</a>
                    <span class="split">|</span>
                    <a href="https://daxue.qq.com/" target="_blank" rel="nofollow">腾讯大学</a>
                    <span class="split">|</span>
                    <a href="https://ke.qq.com/" target="_blank" rel="nofollow">腾讯课堂</a>
                    <span class="split">|</span>
                    <a href="https://tgideas.qq.com/" target="_blank" rel="nofollow">TGideas</a>
                    <span class="split">|</span>
                    <a href="http://ieg.tencent.com/" target="_blank" rel="nofollow">腾讯互动娱乐</a>
                </div>
            </div>
            <div class="aboutus">
                <div class="sitelink">
                    <a href="https://gameinstitute.qq.com/" rel="nofollow">网站导航</a>
                    <a href="https://gameinstitute.qq.com/beginner" rel="nofollow">筑梦成长</a>
                    <a href="https://gameinstitute.qq.com/aboutus" rel="nofollow">关于我们</a>
                    <a href="https://gameinstitute.qq.com/about/agreement" rel="nofollow">用户协议</a>
                    <a href="https://gameinstitute.qq.com/about/knowledge" rel="nofollow">产权声明</a>
                    <a href="https://gameinstitute.qq.com/about/complaint" rel="nofollow">侵权投诉指引</a>
                </div>
                <p>COPYRIGHT © 1998 – 2019 TENCENT. ALL RIGHTS RESERVED. </p>
            </div>
        </div>
        <div class="followus">
            <h3>关注我们</h3>
            <div class="thumb"><img width="120" height="120" src="./四叉树优化碰撞检测-腾讯游戏学院_files/qrcode.png" alt=""></div>
            <p>腾讯游戏学院公众号</p>
        </div>
    </div>
</footer>
    <div class="m-side">
        <div class="side-qrcode">
            <div class="side-ico qrcode"><span class="gico-qrcode"></span></div>
            <div class="qrcode-cnt">
                <div class="qrcode-pic"><img width="100" height="100" src="./四叉树优化碰撞检测-腾讯游戏学院_files/qrcode.png" alt="游戏学院公众号二维码"></div>
                <div class="qrcode-text">
                    <h5 class="title">腾讯游戏学院<br>微信公众号</h5>
                    <p class="intro">提供更专业的游戏知识学习平台</p>
                </div>
            </div>
        </div>
        <a class="side-ico backtop" href="https://gameinstitute.qq.com/community/detail/107937#"><span class="gico-backtop"></span></a>
    </div>



        <login ref="login" @getuserinfo="getUserInfo"></login>
    </div>
                <script>
            window.liked = false;
            window.like_count = 0;
            window.followed = false;
            window.itself = false;
        </script>
        <script src="./四叉树优化碰撞检测-腾讯游戏学院_files/ckeditor.js.下载"></script>
    <script src="./四叉树优化碰撞检测-腾讯游戏学院_files/detail.b57141.js.下载"></script>
    <script>var _mtac={};(function(){var b=document.createElement("script");b.src="//pingjs.qq.com/h5/stats.js?v2.0.2";b.setAttribute("name","MTAH5");b.setAttribute("sid","500607596");b.setAttribute("cid", "500607598");var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)})();</script>


</body></html>