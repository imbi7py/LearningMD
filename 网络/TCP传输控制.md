####TCP概述

**主要特点**

- **面向连接**的运输层协议，即传输数据前必须先建立连接。
- 每条TCP连接只能有两个**端点（Socket）**，每条TCP连接只能**点对点**连接。<u>socket 由IP地址和端口号组成。</u>
- TCP提供**可靠交付**服务。通过TCP传输的数据，无差错、不丢失、不重复并且**按序到达**。
- TCP提供**全双工通信**。收发双方可以任何时候发送数据。
- 面向**字节流**。“流”是指 *流入到进程* 或 *从进程中流出的字节序列*。“面向字节流”的含义是：虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP吧应用程序交下来的数据仅仅看成是一连串的**无结构的字节流**。TCP不保证接收方应用程序所接收的**数据块**和发送方应用程序所发送的数据块具有对应大小的关系。但是，接收方应用程序收到的**字节流**必须和发送方应用程序发出的字节流完全一致。

#### 可靠传输的工作原理

TCP下面的网络是不可靠传输，所以TCP必须采取适当措施才能使得两个传输层之间的通信变得可靠。

- 停止等待协议：发送方获取确认接收后再发送后续分组；使用 超时重传 来避免差错。
- 连续ARQ协议（滑动窗口基础）：发送方维持着一个一定大小的发送窗口，位于发送窗口内的所有分组都可连续发送出去，而中途不需要等待对方的确认。这样信道的利用率就提高了。而发送方每收到一个确认就把发送窗口向前滑动一个分组的位置。接收方一般都是采用积累确认的方式。这就是说，接收方不必对收到的分组逐个发送确认，而是在收到几个分组后，**对按序到达的最后一个分组发送确认**。

#### TCP可靠传输的实现

**字节为单位的滑动窗口**

窗口是缓存的一部分，用来暂时存放字节流。发送方和接收方各有一个窗口，接收方通过 TCP 报文段中的窗口字段告诉发送方自己的窗口大小，发送方根据这个值和其它信息设置自己的窗口大小。

发送方将窗口内的分组连续发送后等待确认；接收方返回按序到达的最高分组序号并且将分组交付主机并且将窗口移动那么多格，将没有按序接收的分组暂存在窗口中；发送方收到确认，窗口移动确认格数，然后将窗口内的分组再次发送。如果没有收到确认信息，发送方将重新传送窗口内分组。

![img](https://cyc2018.github.io/CS-Notes/pics/a3253deb-8d21-40a1-aae4-7d178e4aa319.jpg)

#### TCP的流量控制

流量控制是为了控制发送方发送速率，保证接收方来得及接收。

接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方不能发送数据。

#### TCP的拥塞控制

如果网络出现拥塞，分组将会丢失，此时发送方会继续重传，从而导致网络拥塞程度更高。因此当出现拥塞时，应当控制发送方的速率。这一点和流量控制很像，但是出发点不同。流量控制是为了让接收方能来得及接收，而拥塞控制是为了降低整个网络的拥塞程度。

![img](https://cyc2018.github.io/CS-Notes/pics/51e2ed95-65b8-4ae9-8af3-65602d452a25.jpg)

TCP 主要通过四个算法来进行拥塞控制：慢开始、拥塞避免、快重传、快恢复。

发送方需要维护一个叫做拥塞窗口（cwnd）的状态变量，注意拥塞窗口与发送方窗口的区别：拥塞窗口只是一个状态变量，实际决定发送方能发送多少数据的是发送方窗口。

为了便于讨论，做如下假设：

- 接收方有足够大的接收缓存，因此不会发生流量控制；
- 虽然 TCP 的窗口基于字节，但是这里设窗口的大小单位为报文段。

![img](https://cyc2018.github.io/CS-Notes/pics/910f613f-514f-4534-87dd-9b4699d59d31.png)

1. 慢开始和拥塞避免

发送的最初执行慢开始，令 cwnd = 1，发送方只能发送 1 个报文段；当收到确认后，将 cwnd 加倍，因此之后发送方能够发送的报文段数量为：2、4、8 ...

注意到慢开始每个轮次都将 cwnd 加倍，这样会让 cwnd 增长速度非常快，从而使得发送方发送的速度增长速度过快，网络拥塞的可能性也就更高。设置一个慢开始门限 ssthresh，当 cwnd >= ssthresh 时，进入拥塞避免，每个轮次只将 cwnd 加 1。

如果出现了超时，则令 ssthresh = cwnd / 2，然后重新执行慢开始。

2. 快重传和快恢复

在接收方，要求每次接收到报文段都应该对最后一个已收到的有序报文段进行确认。例如已经接收到 M1 和 M2，此时收到 M4，应当发送对 M2 的确认。

在发送方，如果收到三个重复确认，那么可以知道下一个报文段丢失，此时执行快重传，立即重传下一个报文段。例如收到三个 M2，则 M3 丢失，立即重传 M3。

在这种情况下，只是丢失个别报文段，而不是网络拥塞。因此执行快恢复，令 ssthresh = cwnd / 2 ，cwnd = ssthresh，注意到此时直接进入拥塞避免。

慢开始和快恢复的快慢指的是 cwnd 的设定值，而不是 cwnd 的增长速率。慢开始 cwnd 设定为 1，而快恢复 cwnd 设定为 ssthresh。

![img](https://cyc2018.github.io/CS-Notes/pics/f61b5419-c94a-4df1-8d4d-aed9ae8cc6d5.png)